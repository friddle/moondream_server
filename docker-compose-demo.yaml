version: '3.8'

services:
  moondream:
    image: friddlecopper/moondream:latest
    container_name: moondream-server
    ports:
      - "5000:5000"
    environment:
      # HuggingFace token (optional, for model download)
      - HF_TOKEN=${HF_TOKEN:-}
      # API key for X-Moondream-Auth header (optional)
      - VLM_API_KEY=${VLM_API_KEY:-}
      # Disable authentication for testing
      - VLM_AUTH_USERNAME=${VLM_AUTH_USERNAME:-}
      - VLM_AUTH_PASSWORD=${VLM_AUTH_PASSWORD:-}
      # Python output buffering
      - PYTHONUNBUFFERED=1
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    volumes:
      # Mount local cache to avoid re-downloading model
      - ${HF_CACHE_PATH:-./huggingface-cache}:/root/.cache/huggingface
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - moondream-net

networks:
  moondream-net:
    driver: bridge
